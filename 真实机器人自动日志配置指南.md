# 真实机器人自动日志配置指南

## 目标
让真实机器人的日志自动保存到开发机器的 `Config/Real_Logs` 目录，无需手动下载。

## 方案对比

### 方案 1：NFS 网络文件系统（推荐）
- ✅ **实时写入**：机器人直接写入到开发机器
- ✅ **无需手动操作**：比赛结束后日志已经在你的电脑上
- ✅ **性能好**：网络文件系统，延迟低
- ⚠️ 需要配置 NFS 服务器

### 方案 2：SSH 自动上传（备选）
- ✅ **简单**：只需要 SSH 密钥
- ⚠️ **延迟**：比赛结束后才上传
- ⚠️ **可能失败**：网络问题可能导致上传失败

## 快速开始（推荐 NFS 方案）

### 步骤 1：在开发机器上运行设置脚本

```bash
cd /home/lyl/test/MyBuman
./setup_robot_logging.sh
```

选择选项 `1` (NFS) 或 `3` (Both)

脚本会自动：
- 创建 `Config/Real_Logs` 目录
- 安装并配置 NFS 服务器
- 设置 NFS 导出

### 步骤 2：重新编译代码

```bash
cd Make/Linux
make Nao
```

### 步骤 3：部署到机器人

```bash
cd ../..
./deploy -r 1 10.0.70.6 -nc -t 70 -s Default -m 70 -w SPL_A -v 100 -b
```

### 步骤 4：在机器人上挂载 NFS

SSH 到每个机器人并运行：

```bash
ssh nao@10.0.70.6

# 创建挂载点
sudo mkdir -p /mnt/dev_logs

# 挂载 NFS（替换为你的开发机器 IP）
sudo mount -t nfs -o rw,soft,timeo=10 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs

# 验证挂载
df -h | grep dev_logs

# 设置开机自动挂载
echo "10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs nfs rw,soft,timeo=10 0 0" | sudo tee -a /etc/fstab
```

对每个机器人重复此步骤（10.0.70.6, 10.0.70.7, 等）

### 步骤 5：测试

1. 启动 GameController
2. 让机器人进入比赛状态
3. 检查开发机器上的日志：
   ```bash
   ls -la Config/Real_Logs/
   ```

你应该能看到实时生成的日志文件！

## 手动配置（详细步骤）

### 在开发机器上配置 NFS 服务器

#### 1. 安装 NFS 服务器
```bash
sudo apt-get update
sudo apt-get install nfs-kernel-server
```

#### 2. 创建日志目录
```bash
mkdir -p /home/lyl/test/MyBuman/Config/Real_Logs
```

#### 3. 配置 NFS 导出
编辑 `/etc/exports`：
```bash
sudo nano /etc/exports
```

添加以下行（替换为你的实际路径）：
```
/home/lyl/test/MyBuman/Config/Real_Logs 10.0.70.0/24(rw,sync,no_subtree_check,no_root_squash)
```

说明：
- `10.0.70.0/24` - 允许所有 10.0.70.x 的机器人访问
- `rw` - 读写权限
- `sync` - 同步写入
- `no_subtree_check` - 提高性能
- `no_root_squash` - 允许 root 用户写入

#### 4. 应用配置并重启 NFS
```bash
sudo exportfs -ra
sudo systemctl restart nfs-kernel-server
sudo systemctl enable nfs-kernel-server
```

#### 5. 检查 NFS 状态
```bash
sudo exportfs -v
sudo systemctl status nfs-kernel-server
```

#### 6. 配置防火墙（如果启用）
```bash
sudo ufw allow from 10.0.70.0/24 to any port nfs
```

### 在机器人上配置 NFS 客户端

对每个机器人执行：

```bash
# SSH 到机器人
ssh nao@10.0.70.6

# 安装 NFS 客户端（如果没有）
sudo apt-get install nfs-common

# 创建挂载点
sudo mkdir -p /mnt/dev_logs

# 测试挂载（替换为你的开发机器 IP）
sudo mount -t nfs -o rw,soft,timeo=10 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs

# 验证挂载成功
df -h | grep dev_logs
ls -la /mnt/dev_logs

# 测试写入
echo "test" | sudo tee /mnt/dev_logs/test.txt

# 如果成功，设置开机自动挂载
echo "10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs nfs rw,soft,timeo=10 0 0" | sudo tee -a /etc/fstab
```

## 日志文件结构

```
Config/Real_Logs/
├── 20260127_223000/          # 比赛时间戳
│   └── Team70/               # 队伍编号
│       ├── team_comm_p1.txt  # 1号机器人日志
│       ├── team_comm_p2.txt  # 2号机器人日志
│       ├── team_comm_p3.txt  # 3号机器人日志
│       ├── team_comm_p4.txt  # 4号机器人日志
│       └── team_comm_p5.txt  # 5号机器人日志
├── 20260127_230000/          # 下一场比赛
│   └── Team70/
│       └── ...
```

## 故障排查

### 问题 1：机器人无法挂载 NFS

**检查网络连接：**
```bash
# 在机器人上
ping 10.0.1.100  # 你的开发机器 IP
```

**检查 NFS 服务器：**
```bash
# 在开发机器上
sudo systemctl status nfs-kernel-server
sudo exportfs -v
```

**检查防火墙：**
```bash
# 在开发机器上
sudo ufw status
sudo ufw allow from 10.0.70.0/24
```

### 问题 2：日志没有出现在 Real_Logs

**检查挂载状态：**
```bash
# 在机器人上
mount | grep dev_logs
```

**检查日志路径：**
```bash
# 在机器人上
ls -la /mnt/dev_logs/
```

**查看机器人日志：**
```bash
# 在机器人上
journalctl -u bhuman.service -f
```

### 问题 3：权限错误

**在开发机器上设置权限：**
```bash
chmod 777 /home/lyl/test/MyBuman/Config/Real_Logs
```

**或者更安全的方式：**
```bash
# 创建 nao 用户组
sudo groupadd nao
sudo usermod -a -G nao lyl
sudo chown -R lyl:nao /home/lyl/test/MyBuman/Config/Real_Logs
sudo chmod -R 775 /home/lyl/test/MyBuman/Config/Real_Logs
```

### 问题 4：NFS 挂载很慢或超时

使用更宽松的挂载选项：
```bash
sudo mount -t nfs -o rw,soft,timeo=5,retrans=2,bg 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs
```

## 备选方案：SSH 自动上传

如果 NFS 配置有问题，可以使用 SSH 自动上传方案：

### 1. 设置 SSH 密钥

```bash
# 在开发机器上生成密钥
ssh-keygen -t rsa -b 4096

# 复制到每个机器人
ssh-copy-id nao@10.0.70.6
ssh-copy-id nao@10.0.70.7
# ... 等等
```

### 2. 在机器人上创建上传脚本

已经包含在 `Install/Files/uploadLogs.sh` 中，部署时会自动复制到机器人。

### 3. 手动触发上传

```bash
# 在机器人上
/home/nao/uploadLogs.sh upload
```

## 性能优化

### 1. 使用 UDP 挂载（更快但可能丢数据）
```bash
sudo mount -t nfs -o rw,soft,udp 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs
```

### 2. 增加缓存
```bash
sudo mount -t nfs -o rw,soft,rsize=8192,wsize=8192 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs
```

### 3. 异步写入
```bash
sudo mount -t nfs -o rw,soft,async 10.0.1.100:/home/lyl/test/MyBuman/Config/Real_Logs /mnt/dev_logs
```

## 总结

1. **最简单的方式**：运行 `./setup_robot_logging.sh`，选择 NFS
2. **在每个机器人上挂载 NFS**：`sudo mount -t nfs ...`
3. **重新编译和部署**：`make Nao && ./deploy ...`
4. **开始比赛**：日志自动出现在 `Config/Real_Logs/`

现在你的真实机器人日志会自动保存到开发机器上，和虚拟机器人一样方便！
